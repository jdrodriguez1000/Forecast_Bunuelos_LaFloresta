# Configuraci√≥n del Proyecto: Pron√≥stico Bu√±uelos La Floresta
# Este archivo centraliza los par√°metros operativos y el contrato de datos.

project_name: "Bu√±uelos La Floresta Forecasting"

# üìÇ Rutas del Sistema (Single Source of Truth)
paths:
  raw_data: "data/01_raw/ventas_mensuales.csv"
  cleansed_data: "data/02_cleansed/"
  features_data: "data/03_features/"
  processed_data: "data/04_processed/"
  reports: "outputs/reports/"
  figures: "outputs/figures/"
  models: "outputs/models/"
  metrics: "outputs/metrics/"
  forecasts: "outputs/forecasts/"


# üìú Contrato de Datos (Schema Enforcement - Phase 1)
# Aqu√≠ definimos exactamente qu√© columnas permitimos y de qu√© tipo deben ser.
data_contract:
  columns:
    fecha: "datetime"
    unidades_vendidas_mensuales: "int"
  allow_extra_columns: false  # Si viene una columna no declarada, el sistema fallar√°.

# üß† Par√°metros del Modelo y Negocio
forecasting:
  horizon: 6            # Pron√≥stico obligatorio de 6 meses (X+1 a X+6)
  gap: 0                # Salto del mes actual (Mes X) para predecir X+1 a X+6
  random_state: 42      # Semilla para reproducibilidad total
  test_size: 0.2        # Proporci√≥n para validaci√≥n inicial

# üîç Configuraci√≥n de Descubrimiento (Phase 1)
discovery:
  sentinel_values_numeric: [0, -1, 99, 999, 9999]
  sentinel_values_categorical: [" ", "N/A", "NA", "UNKNOWN", "EMPTY"]
  output_report_name: "phase_01_discovery_report.json"

# üßº Configuraci√≥n de Preprocesamiento (Phase 2)
preprocessing:
  rename_columns:
    unidades_vendidas_mensuales: "unidades"
    
  sentinels:
    values: [0, -1, 999, 9999]
    action: "validate_and_nan"  # Convertir a NaN para imputaci√≥n posterior

  time_series:
    frequency: "MS"             # Inicio de mes (Month Start)
    exclude_current_month: true # Regla del Mes X: Cortar datos del mes en curso
    date_column: "fecha"

  imputation:
    method: "ffill"             # Forward Fill para mantener la inercia
    fallback_method: "bfill"    # Backfill solo si el primer dato es nulo
    
  outliers:
    method: "iqr"               # M√©todo robusto Intercuartil
    iqr_multiplier: 1.5         # Sensibilidad est√°ndar
    flag_column: "es_atipico"   # Nombre de la nueva columna binaria
    
  output:
    filename: "ventas_preprocesadas.csv"
    report_name: "phase_02_preprocessing_report.json"

# üìä Configuraci√≥n de An√°lisis Exploratorio (EDA - Phase 3)
eda:
  input:
    sales_file: "ventas_preprocesadas.csv"
    macro_file: "macro_colombia.csv" # Ubicado en data/03_features/
  
  output:
    report_name: "phase_03_summary_eda.json"
    drift_report_prefix: "data_drift"
    figures_dir: "eda/"

  splitting:
    method: "dynamic"
    description: "Divisi√≥n autom√°tica basada en el √∫ltimo mes completo disponible"
    validation_months: 12
    test_months: 12

  business_rules:
    structural_breaks:
      covid_period:
        start: "2020-05-01"
        end: "2021-02-28"
        label: "Impacto_COVID_Pandemia"
      
      gran_superficie_contract:
        start: "2022-06-01"
        label: "Cambio_Nivel_Retail"
    
    seasonal_events:
      feria_flores:
        month: 8
        label: "Evento_Feria_Flores"
      semana_santa:
        method: "dynamic"
        label: "Evento_Semana_Santa_Movil"
      picos_demanda:
        fin_ano: [12, 1]
        mitad_ano: [6, 7]

    exogenous_variables:
      economic: ["IPC", "TRM"]
      calendar: ["Festivos_Mes", "Fines_Semana_Mes"]

  analysis_params:
    lags_plot: 24 
    stationarity_threshold: 0.05
    decomposition_model: "additive"

# üõ†Ô∏è Configuraci√≥n de Ingenier√≠a de Caracter√≠sticas (Phase 4)
feature_engineering:
  input:
    sales_file: "ventas_preprocesadas.csv"
    macro_file: "macro_colombia.csv"
  
  output:
    filename: "ventas_features.parquet"
    report_name: "phase_04_summary_fe.json"

  # 1. Variables de Calendario y Eventos Detallados
  calendar:
    country: "Colombia"
    features:
      - "festivos_conteo"
      - "fines_semana_conteo"
      - "es_semana_santa"
      - "es_feria_flores"
      - "conteo_novenas"        # D√≠as 16-24 de Diciembre
      - "es_puente_festivo"     # Marcador de lunes festivo (turismo/ocio)
      - "efecto_quincena"       # Fines de semana pr√≥ximos a d√≠as 15 y 30
      - "mes_sin"
      - "mes_cos"
      - "trimestre_sin"
      - "trimestre_cos"
  
  # 2. Hitos Estructurales y Contexto de Negocio
  structural_flags:
    covid_impact:
      start: "2020-05-01"
      end: "2021-02-28"
    retail_expansion:
      start: "2022-06-01"
    contract_maturation:        # Tiempo transcurrido desde hito clave
      reference_date: "2022-06-01"

  # 3. Intensidad Estacional (Mapeo de Importancia)
  # Ayuda al modelo a diferenciar la magnitud de los picos.
  intensity_mapping:
    super_pico: [12]            # Diciembre (Explosi√≥n de ventas)
    pico_alto: [6, 8]           # Junio (Primas) y Agosto (Feria de Flores)
    pico_medio: [7, 12]         # Julio (Vacaciones)
    normal: [1, 2, 3, 4, 5, 9, 10, 11]

  # 4. Momentum y Crecimiento (Captura de Tendencia Reciente)
  growth_momentum:
    yoy_comparison: true        # Comparar con mismo mes del a√±o anterior
    rolling_windows: [3, 6]     # Ventanas para calcular media m√≥vil de crecimiento

  # 5. Variables Macroecon√≥micas y Econ√≥micas
  macro_selection:
    columns:
      - "ipc_mensual"
      - "ipc_alimentos_mensual" # Cr√≠tico para consumo popular
      - "trm_promedio"
      - "tasa_desempleo"
      - "costo_insumos_index"
      - "mes_de_prima"          # Junio y Diciembre (Inyecci√≥n de liquidez)

# ==============================================================================
# 5. Par√°metros GLOBALES de Entrenamiento y Experimentaci√≥n (Phase 5)
# ==============================================================================
training_parameters:
  # --- Par√°metros de Negocio ---
  forecast_horizon: 6
  gap: 0
  
  # --- Par√°metros de Evaluaci√≥n y Selecci√≥n ---
  metric_for_tuning: 'mean_absolute_error'
  n_top_candidates_to_validate: 5 

  # --- Par√°metros para el Grid Search de skforecast ---
  grid_search_cv_params:
    initial_train_size: null 
    steps: 6
    refit: false 
    fixed_train_size: false
    allow_incomplete_folds: true
    return_best: true
    verbose: false

  # Grillas para Grid Search
  hyperparameter_grids:
    LightGBM:
      n_estimators      : [100, 500]
      max_depth         : [5, 10]
      learning_rate     : [0.01, 0.1]
      num_leaves        : [31, 64]
      
    RandomForest:
      n_estimators      : [100, 500]
      max_depth         : [10, 20, 30, null]
      min_samples_split : [2, 10]
      
    Ridge:
      alpha: [0.1, 1.0, 10.0, 100.0]
    
    GradientBoostingRegressor:
      n_estimators      : [100, 300]
      learning_rate     : [0.01, 0.1]
      max_depth         : [3, 7]

    HistGradientBoostingRegressor:
      learning_rate     : [0.01, 0.1]
      max_iter          : [100, 300]
      max_leaf_nodes    : [20, 40]

    xgb.XGBRegressor:
      n_estimators      : [100, 500]
      learning_rate     : [0.01, 0.1]
      max_depth         : [3, 7]

# ==============================================================================
# 6. ESPACIOS DE B√öSQUEDA PARA OPTIMIZACI√ìN BAYESIANA
# ==============================================================================
bayesian_search_spaces:
  xgb.XGBRegressor:
    n_estimators: ['suggest_int', 100, 1000]
    max_depth: ['suggest_int', 3, 10]
    learning_rate: ['suggest_float', 0.01, 0.2, {'log': true}]
    subsample: ['suggest_float', 0.6, 1.0]

  LightGBM:
    n_estimators: ['suggest_int', 100, 1000]
    max_depth: ['suggest_int', 5, 20]
    learning_rate: ['suggest_float', 0.01, 0.2, {'log': true}]
    num_leaves: ['suggest_int', 20, 128]
    
  RandomForest:
    n_estimators: ['suggest_int', 100, 800]
    max_depth: ['suggest_int', 10, 25]

# ==============================================================================
# 7. CONFIGURACI√ìN DE MODELOS DE L√çNEA BASE (BASELINES)
# ==============================================================================
baseline_models:
  - name: 'run00_naive_baseline'
    enabled: true
    description: 'Pron√≥stico ingenuo estacional (X = X-12).'
    forecaster_type: 'ForecasterEquivalentDate'
    forecasting_parameters:
      offset: 12    
      n_offsets: 1      
    exogenous_features:
      features_to_use: []
    preprocessing:
      target_transform: null
      differentiation: 0

# ==============================================================================
# 8. LISTA DE EXPERIMENTOS (Hoja de Ruta del Torneo)
# ==============================================================================
experiments:
  # EXPERIMENTO 01: Solo historia (Laboratorio T√©cnico)
  - name: 'run01_endogenous'
    enabled: true
    description: 'Hip√≥tesis: Calibraci√≥n t√©cnica (Dif vs Trans) usando solo el pasado de la serie.'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
  
  # EXPERIMENTO 02: Solo variables "nativas" del calendario
  - name: 'run02_with_calendar_features'
    enabled: true
    description: 'Hip√≥tesis: Variables c√≠clicas (Sin/Cos) + A√±o y Semestre capturan mejor la periodicidad.'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
    exogenous_features:
      features_to_use: ['mes_sin', 'mes_cos', 'trimestre_sin', 'trimestre_cos', 'anio', 'semestre']

  # EXPERIMENTO 03: Calendario Nativo + Eventos/Conteo
  - name: 'run03_full_calendar_features'
    enabled: true
    description: 'Hip√≥tesis: Calendario completo (C√≠clico + Eventos como Festivos y Feria de Flores).'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
    exogenous_features:
      features_to_use: ['mes_sin', 'mes_cos', 'trimestre_sin', 'trimestre_cos', 'anio', 'semestre', 'festivos_conteo', 'fines_semana_conteo', 'es_semana_santa', 'es_feria_flores', 'mes_de_prima', 'conteo_novenas', 'es_puente_festivo', 'efecto_quincena']

  # EXPERIMENTO 04: Impacto de Hitos Estructurales
  - name: 'run04_structural_evolution'
    enabled: true
    description: 'Hip√≥tesis: El calendario completo m√°s los hitos de COVID y la entrada a Retail.'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
    exogenous_features:
      features_to_use: ['mes_sin', 'mes_cos', 'trimestre_sin', 'trimestre_cos', 'anio', 'semestre', 'festivos_conteo', 'fines_semana_conteo', 'es_semana_santa', 'es_feria_flores', 'mes_de_prima', 'conteo_novenas', 'es_puente_festivo', 'efecto_quincena', 'flag_covid', 'flag_retail', 'maduracion_contrato']

  # EXPERIMENTO 05: Contexto Macroecon√≥mico
  - name: 'run05_macro_context'
    enabled: true
    description: 'Hip√≥tesis: Variables econ√≥micas como Inflaci√≥n (IPC) y TRM ayudan a predecir cambios.'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
    exogenous_features:
      features_to_use: ['mes_sin', 'mes_cos', 'trimestre_sin', 'trimestre_cos', 'anio', 'semestre', 'festivos_conteo', 'fines_semana_conteo', 'es_semana_santa', 'es_feria_flores', 'mes_de_prima', 'conteo_novenas', 'es_puente_festivo', 'efecto_quincena', 'flag_covid', 'flag_retail', 'maduracion_contrato', 'intensidad_comercial', 'crecimiento_yoy', 'growth_momentum_3m', 'growth_momentum_6m', 'ipc_mensual', 'trm_promedio', 'tasa_desempleo', 'costo_insumos_index', 'ipc_alimentos_mensual']

  # EXPERIMENTO 06: Modelo Maestro Integral (Todas las variables - Sin Pesos)
  - name: 'run06_master_integral'
    enabled: true
    description: 'Hip√≥tesis: El modelo combina todas las variables ex√≥genas disponibles sin aplicar pesos temporales.'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
    exogenous_features:
      features_to_use: 'all'

  # EXPERIMENTO FINAL: Optimizaci√≥n por Eras (Ponderaci√≥n)
  - name: 'run_final'
    enabled: true
    description: 'Hip√≥tesis: Aplicar pesos por etapas al mejor modelo descubierto en los pasos anteriores mejora el pron√≥stico final.'
    models_to_train:
      - 'LightGBM'
      - 'RandomForest'
      - 'Ridge'
      - 'xgb.XGBRegressor'
    forecasting_parameters:
      type: 'ForecasterDirect'
      gap: 0
      lags_grid:
        - [1, 2, 3]
      window_features:
        enabled: true
        stats: ['mean', 'mean', 'mean', 'std', 'std', 'std', 'max', 'max', 'max']
        window_sizes: [3, 6, 12, 3, 6, 12, 3, 6, 12]
    training_options:
      use_weights: true
      event_definitions:
          fase_pre_pandemia: { start_date: '2018-01-01', end_date: '2020-04-30' }
          fase_crisis_covid: { start_date: '2020-05-01', end_date: '2021-02-28' }
          fase_recuperacion: { start_date: '2021-03-01', end_date: '2022-05-31' }
          fase_retail:       { start_date: '2022-06-01', end_date: '2026-12-31' }
      weight_function_type: 'by_era' 
      weight_distribution:
        default: 0.5
        fase_pre_pandemia: 0.5
        fase_crisis_covid: 0.1
        fase_recuperacion: 0.7
        fase_retail: 1.0


