# Configuraci√≥n del Proyecto: Pron√≥stico Bu√±uelos La Floresta
# Este archivo centraliza los par√°metros operativos y el contrato de datos.

project_name: "Bu√±uelos La Floresta Forecasting"

# üìÇ Rutas del Sistema (Single Source of Truth)
paths:
  raw_data: "data/01_raw/ventas_mensuales.csv"
  cleansed_data: "data/02_cleansed/"
  features_data: "data/03_features/"
  processed_data: "data/04_processed/"
  reports: "outputs/reports/"
  figures: "outputs/figures/"
  models: "outputs/models/"
  metrics: "outputs/metrics/"

# üìú Contrato de Datos (Schema Enforcement - Phase 1)
# Aqu√≠ definimos exactamente qu√© columnas permitimos y de qu√© tipo deben ser.
data_contract:
  columns:
    fecha: "datetime"
    unidades_vendidas_mensuales: "int"
  allow_extra_columns: false  # Si viene una columna no declarada, el sistema fallar√°.

# üß† Par√°metros del Modelo y Negocio
forecasting:
  horizon: 6            # Pron√≥stico obligatorio de 6 meses (X+1 a X+6)
  random_state: 42      # Semilla para reproducibilidad total
  test_size: 0.2        # Proporci√≥n para validaci√≥n inicial

# üîç Configuraci√≥n de Descubrimiento (Phase 1)
discovery:
  sentinel_values_numeric: [0, -1, 99, 999, 9999]
  sentinel_values_categorical: [" ", "N/A", "NA", "UNKNOWN", "EMPTY"]
  output_report_name: "phase_01_discovery_report.json"

# üßº Configuraci√≥n de Preprocesamiento (Phase 2)
preprocessing:
  rename_columns:
    unidades_vendidas_mensuales: "unidades"
    
  sentinels:
    values: [0, -1, 999, 9999]
    action: "validate_and_nan"  # Convertir a NaN para imputaci√≥n posterior

  time_series:
    frequency: "MS"             # Inicio de mes (Month Start)
    exclude_current_month: true # Regla del Mes X: Cortar datos del mes en curso
    date_column: "fecha"

  imputation:
    method: "ffill"             # Forward Fill para mantener la inercia
    fallback_method: "bfill"    # Backfill solo si el primer dato es nulo
    
  outliers:
    method: "iqr"               # M√©todo robusto Intercuartil
    iqr_multiplier: 1.5         # Sensibilidad est√°ndar
    flag_column: "es_atipico"   # Nombre de la nueva columna binaria
    
  output:
    filename: "ventas_preprocesadas.csv"
    report_name: "phase_02_preprocessing_report.json"

# üìä Configuraci√≥n de An√°lisis Exploratorio (EDA - Phase 3)
eda:
  input:
    sales_file: "ventas_preprocesadas.csv"
    macro_file: "macro_colombia.csv" # Ubicado en data/03_features/
  
  output:
    report_name: "phase_03_summary_eda.json"
    drift_report_prefix: "data_drift"
    figures_dir: "eda/"

  splitting:
    method: "dynamic"
    description: "Divisi√≥n autom√°tica basada en el √∫ltimo mes completo disponible"
    validation_months: 12
    test_months: 12

  business_rules:
    structural_breaks:
      covid_period:
        start: "2020-05-01"
        end: "2021-02-28"
        label: "Impacto_COVID_Pandemia"
      
      gran_superficie_contract:
        start: "2022-06-01"
        label: "Cambio_Nivel_Retail"
    
    seasonal_events:
      feria_flores:
        month: 8
        label: "Evento_Feria_Flores"
      semana_santa:
        method: "dynamic"
        label: "Evento_Semana_Santa_Movil"
      picos_demanda:
        fin_ano: [12, 1]
        mitad_ano: [6, 7]

    exogenous_variables:
      economic: ["IPC", "TRM"]
      calendar: ["Festivos_Mes", "Fines_Semana_Mes"]

  analysis_params:
    lags_plot: 24 
    stationarity_threshold: 0.05
    decomposition_model: "additive"

# üõ†Ô∏è Configuraci√≥n de Ingenier√≠a de Caracter√≠sticas (Phase 4)
feature_engineering:
  input:
    sales_file: "ventas_preprocesadas.csv"
    macro_file: "macro_colombia.csv"
  
  output:
    filename: "ventas_features.parquet"
    report_name: "phase_04_summary_fe.json"

  # 1. Variables de Calendario
  calendar:
    country: "Colombia"
    features:
      - "festivos_conteo"
      - "fines_semana_conteo"
      - "es_semana_santa"
      - "es_feria_flores"
  
  # 2. Hitos Estructurales (Flags)
  structural_flags:
    covid_impact:
      start: "2020-05-01"
      end: "2021-02-28"
    retail_expansion:
      start: "2022-06-01"

  # 3. Variables Macroecon√≥micas Seleccionadas (Basadas en correlaci√≥n de Fase 3)
  macro_selection:
    columns:
      - "ipc_mensual"
      - "trm_promedio"
      - "tasa_desempleo"
      - "costo_insumos_index"
      - "mes_de_prima"

# ==============================================================================
# 5. Par√°metros GLOBALES de Entrenamiento y Experimentaci√≥n (Phase 5)
# ==============================================================================
training_parameters:
  # --- Par√°metros de Negocio ---
  forecast_horizon: 6
  forecast_gap: 1
  
  # --- Par√°metros de Evaluaci√≥n y Selecci√≥n ---
  metric_for_tuning: 'mean_absolute_error'
  n_top_candidates_to_validate: 5 

  # --- Par√°metros para el Grid Search de skforecast ---
  grid_search_cv_params:
    initial_train_size: null 
    steps: 6
    refit: false 
    fixed_train_size: false
    allow_incomplete_folds: true
    return_best: true
    verbose: false

  # Grillas para Grid Search
  hyperparameter_grids:
    LightGBM:
      n_estimators      : [100, 500]
      max_depth         : [5, 10]
      learning_rate     : [0.01, 0.1]
      num_leaves        : [31, 64]
      
    RandomForest:
      n_estimators      : [100, 500]
      max_depth         : [5, 15]
      min_samples_split : [2, 10]
      
    Ridge:
      alpha: [0.1, 1.0, 10.0, 100.0]
    
    GradientBoostingRegressor:
      n_estimators      : [100, 300]
      learning_rate     : [0.01, 0.1]
      max_depth         : [3, 7]

    HistGradientBoostingRegressor:
      learning_rate     : [0.01, 0.1]
      max_iter          : [100, 300]
      max_leaf_nodes    : [20, 40]

    xgb.XGBRegressor:
      n_estimators      : [100, 500]
      learning_rate     : [0.01, 0.1]
      max_depth         : [3, 7]

# ==============================================================================
# 6. ESPACIOS DE B√öSQUEDA PARA OPTIMIZACI√ìN BAYESIANA
# ==============================================================================
bayesian_search_spaces:
  xgb.XGBRegressor:
    n_estimators: ['suggest_int', 100, 1000]
    max_depth: ['suggest_int', 3, 10]
    learning_rate: ['suggest_float', 0.01, 0.2, {'log': true}]
    subsample: ['suggest_float', 0.6, 1.0]

  LightGBM:
    n_estimators: ['suggest_int', 100, 1000]
    max_depth: ['suggest_int', 5, 20]
    learning_rate: ['suggest_float', 0.01, 0.2, {'log': true}]
    num_leaves: ['suggest_int', 20, 128]
    
  RandomForest:
    n_estimators: ['suggest_int', 100, 800]
    max_depth: ['suggest_int', 5, 25]

# ==============================================================================
# 7. CONFIGURACI√ìN DE MODELOS DE L√çNEA BASE (BASELINES)
# ==============================================================================
baseline_models:
  - name: 'run00_naive_baseline'
    enabled: true
    description: 'Pron√≥stico ingenuo estacional (X = X-12).'
    forecaster_type: 'ForecasterEquivalentDate'
    forecasting_parameters:
      offset: 12    
      n_offsets: 1      
    exogenous_features:
      features_to_use: []
    preprocessing:
      target_transform: null
      differentiation: 0

# ==============================================================================
# 8. LISTA DE EXPERIMENTOS (Hoja de Ruta del Torneo)
# ==============================================================================
experiments:
  # EXPERIMENTO 01: Solo historia
  - name: 'run01_endogenous'
    enabled: true
    description: 'Lags y tendencias locales. Sin ex√≥genas.'
    models_to_train: ['LightGBM', 'RandomForest', 'Ridge', 'xgb.XGBRegressor']
    forecasting_parameters:
      type: 'ForecasterDirect'
      lags_grid:
        - [1, 2, 3, 6, 12]
    exogenous_features:
      features_to_use: []
    preprocessing:
      target_transform: null
      differentiation: 0

  # EXPERIMENTO 02: Historia + Calendario
  - name: 'run02_with_calendar'
    enabled: true
    description: 'A√±adir variables de calendario (Festivos, Fines de Semana).'
    models_to_train: ['LightGBM', 'RandomForest', 'Ridge']
    forecasting_parameters:
      type: 'ForecasterDirect'
      lags_grid:
        - [1, 2, 3, 6, 12]
    exogenous_features:
      features_to_use: ['festivos_conteo', 'fines_semana_conteo', 'es_semana_santa']
    preprocessing:
      target_transform: null
      differentiation: 0

  # EXPERIMENTO 03: Modelo Completo + Pesos por Era
  - name: 'run03_full_weighted'
    enabled: true
    description: 'Modelo completo con ponderaci√≥n para mitigar impacto COVID y priorizar Retail.'
    models_to_train: ['LightGBM', 'RandomForest', 'xgb.XGBRegressor']
    forecasting_parameters:
      type: 'ForecasterDirect'
      lags_grid:
        - [1, 2, 3, 6, 12]
    exogenous_features:
      features_to_use: 'all'
      event_definitions:
          fase_pre_pandemia: { start_date: '2018-01-01', end_date: '2020-04-30' }
          fase_crisis_covid: { start_date: '2020-05-01', end_date: '2021-02-28' }
          fase_recuperacion: { start_date: '2021-03-01', end_date: '2022-05-31' }
          fase_retail:       { start_date: '2022-06-01', end_date: '2026-12-31' }
    preprocessing:
      target_transform: 'yeo-johnson'
      differentiation: 0
    training_options:
      use_weights: true
      weight_function_type: 'by_era' 
      weight_distribution:
        default: 0.5
        fase_pre_pandemia: 0.5
        fase_crisis_covid: 0.1      # Ignorar anomal√≠a
        fase_recuperacion: 0.7
        fase_retail: 1.0            # Prioridad m√°xima
